# ============================================================================
# PARAMETERS CONFIGURATION
# ============================================================================
# This file contains all hyperparameters and settings for the segmentation pipeline
# ============================================================================

# ============================================================================
# PREPROCESSING PARAMETERS
# ============================================================================
preprocessing:
  # CT Windowing (Hounsfield Units)
  hu_window:
    min: -1000  # Minimum HU (air)
    max: 400    # Maximum HU (soft tissue/bone boundary)
  
  # Normalization
  normalization:
    method: "z_score"  # Options: "z_score", "min_max", "clip_normalize"
    clip_range: [-1000, 400]
    
  # Resampling
  resampling:
    target_spacing: [1.0, 1.0, 1.0]  # [x, y, z] in mm
    interpolation_image: "linear"     # For CT images
    interpolation_mask: "nearest"     # For masks (preserve labels)
  
  # Image dimensions
  image_size:
    width: 256
    height: 256
    # depth: auto (keep original or slice-wise processing)
  
  # ROI selection
  roi:
    target_structures: ["GTV", "CTV", "PTV", "Lung", "Tumor"]  # Priority ROIs
    combine_method: "union"  # Options: "union", "largest", "priority"
    
# ============================================================================
# DATA SPLITTING
# ============================================================================
data_split:
  train_ratio: 0.70
  val_ratio: 0.15
  test_ratio: 0.15
  random_seed: 42
  stratify: false  # Set to true if you have class labels
  
# ============================================================================
# DATA AUGMENTATION
# ============================================================================
augmentation:
  enabled: true
  train_only: true  # Apply only to training set
  
  # Spatial transformations
  spatial:
    random_flip:
      enabled: true
      axes: [0, 1]  # Horizontal and vertical flips
      probability: 0.5
    
    random_rotation:
      enabled: true
      degrees: [-15, 15]
      probability: 0.3
    
    random_scale:
      enabled: true
      scale_range: [0.9, 1.1]
      probability: 0.3
    
    elastic_deformation:
      enabled: false  # Can be enabled for more augmentation
      alpha: [0, 300]
      sigma: [9, 13]
      probability: 0.2
  
  # Intensity transformations
  intensity:
    random_gamma:
      enabled: true
      gamma_range: [0.8, 1.2]
      probability: 0.3
    
    random_noise:
      enabled: true
      noise_std: 0.01
      probability: 0.2
    
    random_contrast:
      enabled: true
      contrast_range: [0.8, 1.2]
      probability: 0.3

# ============================================================================
# MODEL ARCHITECTURE (U-Net)
# ============================================================================
model:
  architecture: "unet"
  
  # U-Net specific parameters
  unet:
    in_channels: 1      # Grayscale CT
    out_channels: 1     # Binary segmentation
    init_features: 64   # Initial feature maps
    depth: 4            # Number of down/up-sampling blocks
    
    # Architecture components
    use_batchnorm: true
    use_dropout: true
    dropout_rate: 0.3
    
    # Activation functions
    activation: "relu"  # Options: "relu", "leaky_relu", "elu"
    final_activation: "sigmoid"  # For binary: "sigmoid", multi-class: "softmax"

# ============================================================================
# TRAINING PARAMETERS
# ============================================================================
training:
  # Basic settings
  epochs: 100
  batch_size: 8
  num_workers: 4
  pin_memory: true
  
  # Optimizer
  optimizer:
    name: "adam"  # Options: "adam", "sgd", "adamw"
    learning_rate: 0.001
    weight_decay: 0.0001
    
    # Adam specific
    betas: [0.9, 0.999]
    
    # SGD specific (if used)
    momentum: 0.9
    nesterov: true
  
  # Learning rate scheduler
  scheduler:
    enabled: true
    name: "reduce_on_plateau"  # Options: "reduce_on_plateau", "cosine", "step"
    
    # ReduceLROnPlateau
    mode: "min"
    factor: 0.5
    patience: 10
    min_lr: 0.000001
    
    # CosineAnnealingLR (if used)
    T_max: 50
    eta_min: 0.00001
    
    # StepLR (if used)
    step_size: 30
    gamma: 0.1
  
  # Loss function
  loss:
    name: "dice_bce"  # Options: "dice", "bce", "dice_bce", "focal"
    
    # Combined loss weights
    dice_weight: 0.5
    bce_weight: 0.5
    
    # Focal loss parameters (if used)
    focal_alpha: 0.25
    focal_gamma: 2.0
  
  # Early stopping
  early_stopping:
    enabled: true
    patience: 20
    min_delta: 0.001
    monitor: "val_loss"  # Options: "val_loss", "val_dice", "val_iou"
    mode: "min"  # "min" for loss, "max" for metrics
  
  # Checkpointing
  checkpoint:
    save_best: true
    save_last: true
    save_frequency: 5  # Save every N epochs
    monitor: "val_dice"
    mode: "max"
  
  # Mixed precision training
  mixed_precision:
    enabled: false  # Enable if GPU supports (NVIDIA RTX, A100, etc.)
  
  # Gradient clipping
  gradient_clipping:
    enabled: false
    max_norm: 1.0

# ============================================================================
# EVALUATION PARAMETERS
# ============================================================================
evaluation:
  metrics:
    - "dice"
    - "iou"
    - "precision"
    - "recall"
    - "f1_score"
    - "hausdorff_distance"
    - "surface_distance"
  
  # Thresholds for binary prediction
  threshold: 0.5
  
  # Post-processing
  post_processing:
    remove_small_objects: true
    min_size: 100  # pixels
    
    fill_holes: true
    
    connected_components: true
    keep_largest: true

# ============================================================================
# VISUALIZATION PARAMETERS
# ============================================================================
visualization:
  # Image slices to visualize
  num_slices: 5
  slice_selection: "evenly_spaced"  # Options: "evenly_spaced", "random", "specific"
  
  # Figure settings
  figure_size: [15, 10]
  dpi: 150
  
  # Colors
  colormap_image: "gray"
  colormap_mask: "Reds"
  mask_alpha: 0.4
  
  # Save formats
  save_formats: ["png", "pdf"]
  
  # 3D visualization
  render_3d:
    enabled: false  # Can be slow for large volumes
    surface_smoothing: true
    opacity: 0.7

# ============================================================================
# LOGGING AND MONITORING
# ============================================================================
logging:
  # Console logging
  console_level: "INFO"  # Options: "DEBUG", "INFO", "WARNING", "ERROR"
  
  # File logging
  file_level: "DEBUG"
  
  # TensorBoard
  tensorboard:
    enabled: true
    log_images: true
    log_frequency: 10  # Log every N batches
    
  # Weights & Biases (optional)
  wandb:
    enabled: false
    project: "nsclc-segmentation"
    entity: null  # Your W&B username/team

# ============================================================================
# REPRODUCIBILITY
# ============================================================================
reproducibility:
  seed: 42
  deterministic: true
  benchmark: false  # Set true for faster training if input sizes are constant

# ============================================================================
# COMPUTE RESOURCES
# ============================================================================
compute:
  device: "auto"  # Options: "auto", "cuda", "cpu", "cuda:0"
  gpu_id: 0
  multi_gpu: false
  distributed: false
